<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WildPx Model Release</title>
<style>
  :root { --ok:#22c55e; --warn:#ef4444; }
  body{margin:0;font-family:Segoe UI,Tahoma,Arial,sans-serif;color:#fff;background:url('BackgroundImage.png') center/cover fixed no-repeat}
  body::before{content:"";position:fixed;inset:0;background:rgba(0,100,0,.8);z-index:0}
  .overlay{position:relative;z-index:1;background:rgba(0,0,0,.65);max-width:640px;margin:40px auto;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.4)}
  label,select,input,textarea,button{display:block;width:100%;margin-bottom:12px;font-size:1rem}
  input,select,textarea{padding:8px;border:none;border-radius:4px;box-sizing:border-box}
  button{background:#5cb85c;color:#fff;font-weight:700;padding:10px;border:none;border-radius:6px;cursor:pointer}
  button:hover{background:#4cae4c}
  .logo{display:block;margin:0 auto 20px;max-width:200px;user-select:none;-webkit-user-drag:none}
  canvas{background:#fff;border:1px solid #ccc;border-radius:4px;display:block;width:100%;height:150px;margin-bottom:10px;touch-action:none}
  #banner{display:none;position:fixed;left:16px;right:16px;top:12px;z-index:9999;padding:12px;border-radius:8px;text-align:center;font-weight:700}
  #banner.ok{background:rgba(34,197,94,.95)}
  #banner.err{background:rgba(239,68,68,.95)}
  #adminBar{display:none;gap:8px;align-items:center;margin:10px 0}
  #adminBar button{flex:0 0 auto}
  .row-actions{display:flex;gap:12px}
</style>
</head>
<body>
  <!-- Confirmation banner -->
  <div id="banner" role="status" aria-live="polite"></div>

  <div class="overlay">
    <img src="WILDPX-01-5-.png" alt="WildPx Logo" class="logo" />

    <!-- Hidden admin bar (long-press logo to toggle) -->
    <div id="adminBar">
      <button type="button" id="exportAllBtn" style="background:#2563eb">Export All</button>
      <button type="button" id="exportClearBtn" style="background:#7c3aed">Export & Clear</button>
      <span id="savedCount" style="font-size:.9rem;opacity:.85">Saved: 0</span>
    </div>

    <h1>Model & Photo Release Form</h1>

    <form id="releaseForm" novalidate>
      <label>Full Name:
        <input type="text" name="fullName" required />
      </label>
      <label>Address Line 1:
        <input type="text" name="address1" />
      </label>
      <label>Address Line 2:
        <input type="text" name="address2" />
      </label>
      <label>City:
        <input type="text" name="city" />
      </label>
      <label>State:
        <input type="text" name="state" />
      </label>
      <label>Zip Code:
        <input type="text" name="zip" />
      </label>
      <label>Phone:
        <input type="text" name="phone" />
      </label>
      <label>Email:
        <input type="email" name="email" />
      </label>

      <label>Are you at least 18 years of age?
        <select id="ageCheck" name="ageCheck" required>
          <option value="">Select</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </label>

      <div id="childrenSection" style="display:none">
        <h3>Additional Children (if any)</h3>
        <label>Names and ages:
          <textarea name="additionalChildren" rows="3" placeholder="Example: Jane (7), Sam (5)"></textarea>
        </label>
      </div>

      <div id="guardianSection" style="display:none">
        <h3>Parent/Guardian Info</h3>
        <label>Guardian Name:
          <input type="text" name="guardianName" />
        </label>
        <label>Relationship to Participant:
          <input type="text" name="guardianRelationship" />
        </label>
        <label>Guardian Signature:</label>
        <canvas id="guardianSignatureCanvas"></canvas>
        <button type="button" onclick="clearGuardianSig()">Clear Guardian Signature</button>
        <input type="hidden" name="guardianSignature" id="guardianSignatureData" />
      </div>

      <label>
        Please take or upload a photo of yourself.
        <input type="file" name="headshot" accept="image/*" capture="user" />
      </label>

      <p><strong>Photo Release & Copyright Agreement</strong></p>
      <ul>
        <li>I do not own any rights to the images.</li>
        <li>All rights remain with WildPx LLC.</li>
        <li>No compensation unless agreed in writing.</li>
        <li>Images may be edited or modified.</li>
        <li>I waive right to review final use.</li>
      </ul>

      <label>Model Signature:</label>
      <canvas id="modelSignatureCanvas"></canvas>
      <button type="button" onclick="clearModelSig()">Clear Model Signature</button>
      <input type="hidden" name="modelSignature" id="modelSignatureData" />

      <label>Date:
        <input type="date" name="signatureDate" />
        <!-- not required; we auto-fill it on submit -->
      </label>

      <div class="row-actions">
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>

  <!-- SignaturePad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const KEY = 'formEntries'; // localStorage key

    const banner = document.getElementById('banner');
    const savedCountEl = document.getElementById('savedCount');

    const form = document.getElementById('releaseForm');
    const ageSelect = document.getElementById('ageCheck');
    const guardianSection = document.getElementById('guardianSection');
    const childrenSection = document.getElementById('childrenSection');

    const modelCanvas = document.getElementById('modelSignatureCanvas');
    const guardianCanvas = document.getElementById('guardianSignatureCanvas');

    const modelSigField = document.getElementById('modelSignatureData');
    const guardianSigField = document.getElementById('guardianSignatureData');

    const exportAllBtn = document.getElementById('exportAllBtn');
    const exportClearBtn = document.getElementById('exportClearBtn');

    const signatureDateInput = form.querySelector('input[name="signatureDate"]');

    // Banner helpers
    function showBannerOk(msg){
      banner.className = 'ok';
      banner.textContent = msg || 'Saved';
      banner.style.display = 'block';
      setTimeout(() => banner.style.display = 'none', 4000);
    }
    function showBannerErr(msg){
      banner.className = 'err';
      banner.textContent = msg || 'Error';
      banner.style.display = 'block';
      setTimeout(() => banner.style.display = 'none', 5000);
    }

    // Signature pads
    let modelPad = null;
    let guardianPad = null;

    function resizeCanvas(canvas, pad) {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      if (!rect.width) return;
      canvas.width  = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(150 * ratio);
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      if (pad && typeof pad.clear === 'function') pad.clear();
    }

    function initModelPad() {
      if (!window.SignaturePad) return;
      modelPad = new window.SignaturePad(modelCanvas, { penColor: '#000' });
      requestAnimationFrame(() => resizeCanvas(modelCanvas, modelPad));
    }
    function initGuardianPad() {
      if (!window.SignaturePad) return;
      if (!guardianPad) guardianPad = new window.SignaturePad(guardianCanvas, { penColor: '#000' });
      requestAnimationFrame(() => resizeCanvas(guardianCanvas, guardianPad));
    }

    window.clearModelSig = () => { if (modelPad) modelPad.clear(); };
    window.clearGuardianSig = () => { if (guardianPad) guardianPad.clear(); };

    initModelPad();

    window.addEventListener('resize', () => {
      if (modelPad) requestAnimationFrame(() => resizeCanvas(modelCanvas, modelPad));
      if (guardianPad && guardianSection.style.display !== 'none') {
        requestAnimationFrame(() => resizeCanvas(guardianCanvas, guardianPad));
      }
    });

    // Age toggle
    function updateMinorUI() {
      const isMinor = String(ageSelect.value || '').toLowerCase() === 'no';
      guardianSection.style.display = isMinor ? 'block' : 'none';
      childrenSection.style.display = isMinor ? 'block' : 'none';

      const gName = form.querySelector('input[name="guardianName"]');
      const gRel  = form.querySelector('input[name="guardianRelationship"]');
      if (gName) gName.required = isMinor;
      if (gRel)  gRel.required  = isMinor;

      if (isMinor) initGuardianPad();
    }
    ageSelect.addEventListener('change', updateMinorUI);
    ageSelect.addEventListener('input', updateMinorUI);
    updateMinorUI();

    // Utilities
    function getAll() {
      try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; }
    }
    function setAll(arr) {
      localStorage.setItem(KEY, JSON.stringify(arr));
      updateSavedCount();
    }
    function updateSavedCount() {
      const n = getAll().length;
      if (savedCountEl) savedCountEl.textContent = 'Saved: ' + n;
    }
    updateSavedCount();

    function setTodayIfBlank() {
      if (!signatureDateInput.value) signatureDateInput.value = new Date().toISOString().slice(0,10);
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    // Submit (local save only)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Minimal validation (do not rely on required browser validation)
      const fullName = (form.elements['fullName'].value || '').trim();
      const ageVal = String(ageSelect.value || '').toLowerCase();
      const isMinor = ageVal === 'no';

      if (!fullName) { showBannerErr('Please enter full name.'); return; }
      if (!ageVal)   { showBannerErr('Please select Yes/No for age.'); return; }
      if (!modelPad || modelPad.isEmpty()) { showBannerErr('Please sign as model.'); return; }
      if (isMinor) {
        const gName = (form.elements['guardianName'].value || '').trim();
        const gRel  = (form.elements['guardianRelationship'].value || '').trim();
        if (!gName || !gRel) { showBannerErr('Guardian name and relationship required.'); return; }
        if (!guardianPad || guardianPad.isEmpty()) { showBannerErr('Guardian signature required.'); return; }
      }

      setTodayIfBlank();

      // capture signatures
      modelSigField.value = modelPad.toDataURL('image/jpeg', 0.85);
      guardianSigField.value = (isMinor && guardianPad && !guardianPad.isEmpty())
        ? guardianPad.toDataURL('image/jpeg', 0.85) : '';

      // build entry
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      data.timestamp = new Date().toISOString();

      // Optional: try to store headshot only if reasonably small
      const file = form.elements['headshot']?.files?.[0];
      if (file) {
        try {
          if (file.size <= 300000) { // ~300 KB
            data.headshotDataURL = await fileToDataURL(file);
          } else {
            data.headshotNote = 'Headshot present but large; not saved inline (' + file.size + ' bytes)';
          }
        } catch (err) {
          data.headshotNote = 'Headshot present but could not be read';
        }
      }

      // save locally
      try {
        const all = getAll();
        all.push(data);
        setAll(all);
      } catch (err) {
        showBannerErr('Could not save locally. Check browser settings.');
        return;
      }

      // reset UI
      form.reset();
      if (modelPad) modelPad.clear();
      if (guardianPad) guardianPad.clear();
      updateMinorUI();
      window.scrollTo({ top: 0, behavior: 'smooth' });

      showBannerOk('Saved locally. Total: ' + getAll().length);
    }, { capture: true });

    // Hidden admin bar reveal: long-press on logo
    (function setupAdminReveal(){
      const logo = document.querySelector('.logo');
      const adminBar = document.getElementById('adminBar');
      if (!logo || !adminBar) return;

      let pressTimer = null;
      const start = () => { pressTimer = setTimeout(() => {
        adminBar.style.display = (adminBar.style.display === 'none' || !adminBar.style.display) ? 'flex' : 'none';
      }, 1200); };
      const cancel = () => { if (pressTimer) clearTimeout(pressTimer); };

      logo.addEventListener('mousedown', start);
      logo.addEventListener('touchstart', start, {passive:true});
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => logo.addEventListener(ev, cancel));
    })();

    // Export all into one JSON bundle
    function downloadJSON(filename, obj) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    exportAllBtn.addEventListener('click', () => {
      const entries = getAll();
      if (!entries.length) { showBannerErr('No saved forms to export.'); return; }
      const bundle = { exported_at: new Date().toISOString(), count: entries.length, entries };
      const fn = 'wildpx_releases_' + new Date().toISOString().slice(0,10) + '_n' + entries.length + '.json';
      downloadJSON(fn, bundle);
      showBannerOk('Exported ' + entries.length + ' forms.');
    });

    // Export and clear
    exportClearBtn.addEventListener('click', () => {
      const entries = getAll();
      if (!entries.length) { showBannerErr('Nothing to export.'); return; }
      if (!confirm('Export all forms and then clear them from this device?')) return;

      const bundle = { exported_at: new Date().toISOString(), count: entries.length, entries };
      const fn = 'wildpx_releases_' + new Date().toISOString().slice(0,10) + '_n' + entries.length + '.json';
      downloadJSON(fn, bundle);

      localStorage.removeItem(KEY);
      updateSavedCount();
      showBannerOk('Exported and cleared.');
    });
  });
  </script>
</body>
</html>
